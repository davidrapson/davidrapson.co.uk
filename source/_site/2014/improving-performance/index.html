<!DOCTYPE html><html lang="en-GB" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Improving performance</title><meta name="description" content="Pre-requisites"><link rel="canonical" href="http://davidrapson.co.uk/2014/improving-performance/"><link rel="alternate" type="application/atom+xml" title="David Rapson" href="http://davidrapson.co.uk/feed.xml"/><meta property="og:title" content="Improving performance"/><meta property="og:site_name" content="David Rapson"/><meta property="og:url" content="/2014/improving-performance/"/><meta property="og:description" content="Pre-requisites"/><link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="icon" type="image/x-icon" href="/favicon.ico"/><meta name="theme-color" content="#b60000"> <style>html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background:0 0}b,strong{font-weight:700}dfn{font-style:italic}mark{background:#ff0;color:#000}small{font-size:80%}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield;box-sizing:content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}html{font-size:100%;line-height:1.6}body{color:#444;background-color:#fff}html,body,button,input,select,textarea,.ff-body{font-family:"soleil",sans-serif}h1,h2,h3,h4,h5,h6,.ff-display{font-family:"jaf-bernina-sans-condensed",sans-serif}.ff-caption{font-family:sans-serif}pre,code,kbd,samp,.ff-mono{font-family:"Menlo","Bitstream Vera Sans",Monaco,"Andale Mono","Lucida Console","Droid Mono",monospace}h1{font-size:1.625rem}h2{font-size:1.5rem}h3{font-size:1.3125rem}h4{font-size:1.125rem}h5{font-size:1rem}h6{font-size:.875rem}@media (min-width:30em){h1{font-size:2rem}}h1,h2,h3,h4,h5,h6{color:#595959;line-height:1.1;margin:0;font-weight:800}h6{text-transform:uppercase}a{color:#b60000;font-weight:700;text-decoration:none;word-wrap:break-word;line-height:inherit}a:hover{color:shade(#b60000,50%);cursor:pointer}a:hover,a:active{outline:0}a:focus{outline:thin dotted}p,ul,ol,dl{margin-top:0;margin-bottom:.75em}ul{list-style:disc outside}ol{list-style:decimal outside}dl dt{font-weight:700}dl dd{margin:0 0 1.5em}blockquote{margin:0}abbr[title],dfn[title]{cursor:help;border-bottom:1px dotted}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}.l-constrained{width:94%;min-width:0;margin:0 auto}.l-constrained:before,.l-constrained:after{content:" ";display:table}.l-constrained:after{clear:both}@media (min-width:50em){.l-constrained{max-width:620px}}html{height:100%;border-top:10px solid #b60000}body{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-height:100vh;-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column}.main{-webkit-box-flex:1;-webkit-flex:1;-ms-flex:1;flex:1;margin-bottom:2em}.u-text-lead{font-size:120%;line-height:1.333;font-weight:300;margin-bottom:1em}.u-text-title{margin-top:0}.u-text-tag{text-transform:uppercase;letter-spacing:1px;font-size:85%}.u-text-tag,.u-link-forward,.u-link-backward{font-weight:700}.u-link-forward:after{content:'\2192'}.u-link-backward:before{content:'\2190'}.u-link-block{font-weight:inherit;display:block;height:100%}.u-list-unstyled{list-style:none;padding-left:0}.copy h1,.copy h2,.copy h3,.copy h4,.copy h5,.copy h6,.copy--full h1,.copy--full h2,.copy--full h3,.copy--full h4,.copy--full h5,.copy--full h6{margin-bottom:.3em}.copy p+h1,.copy p+h2,.copy p+h3,.copy p+h4,.copy p+h5,.copy p+h6,.copy--full p+h1,.copy--full p+h2,.copy--full p+h3,.copy--full p+h4,.copy--full p+h5,.copy--full p+h6{margin-top:1.5em}.copy p:empty,.copy--full p:empty{display:none}.copy a,.copy a:visited,.copy a:hover,.copy--full a,.copy--full a:visited,.copy--full a:hover{text-decoration:underline}.copy--full p{margin-bottom:0}.copy--full p+p{text-indent:1.5em}.copy--full blockquote{color:#565656;margin:1.5em 0;padding:.5em 0;border:solid #ddd;border-width:0}@media (min-width:30em){.copy--full blockquote{margin-left:-25px;padding-left:1em;border-width:0 0 0 5px}}.copy--full kbd,.copy--full code{padding:0 .3em;border:1px solid #ddd;background-color:#f8f8f8}.copy--full pre{border:1px solid #ddd;background-color:#f8f8f8;padding:1em 3%;font-size:90%}.copy--full pre code{padding:0;box-shadow:none;border:0 none;font-size:100%}@media (min-width:50em){.copy--full pre{margin:1em -3%}.copy--full ol,.copy--full ul{margin:1em 0 1em -1.5em}}.global-header{margin-bottom:2em;background-color:#f8f8f8;border-bottom:1px solid #e9e9e9}.intro{padding:2em 0}.intro:before,.intro:after{content:" ";display:table}.intro:after{clear:both}.intro__media{width:100px;margin:0 auto 1em}.intro__media img{border-radius:50%}.intro__body{text-align:center}.intro__title{font-size:1.125rem;line-height:1.3;font-family:"soleil",sans-serif;font-weight:400;margin:0}@media (min-width:30em){.intro{display:table}.intro__media,.intro__body{display:table-cell;vertical-align:middle}.intro__media{margin:0;width:120px;padding-right:20px}.intro__body{text-align:left}.intro__title{font-size:1.3125rem}}@media (min-width:62.5em){.intro{position:relative;left:-120px}.intro__title{font-size:1.5rem}}.nav-trail{list-style:none;padding-left:0;margin-bottom:0}.nav-trail__item{margin:0 .5em 0 0;display:inline-block}.nav-trail__item:after{content:'\B7';display:inline-block;margin-left:.5em;color:#565656}.nav-trail__item:last-child{margin-right:0}.nav-trail__item:last-child:after{display:none}.entry-listing{list-style:none;padding-left:0}.entry-listing__item{margin-left:0;padding-bottom:1em;margin-bottom:1em;border-bottom:1px solid #ddd}.entry-listing__item:last-of-type{border-bottom:none}.entry{margin-bottom:0}.entry__title{font-size:1.3125rem;font-family:"soleil",sans-serif;margin-bottom:.2em}.entry__title--external:before{content:'';display:inline-block;vertical-align:middle;width:14px;height:14px;padding-left:6px;background-image:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0ZWQgYnkgSWNvTW9vbi5pbyAtLT4KPCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAxLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkIj4KPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIxNCIgaGVpZ2h0PSIxNCIgdmlld0JveD0iMCAwIDE0IDE0Ij4KPGcgaWQ9Imljb21vb24taWdub3JlIj4KPC9nPgo8cGF0aCBkPSJNNS41MDEgMTAuMjg2bC0wLjU2NyAwLjU2M2MtMC40OTEgMC40ODYtMS4yOSAwLjQ4Ny0xLjc4MSAwLTAuMjM2LTAuMjM1LTAuMzY1LTAuNTQ1LTAuMzY1LTAuODc2czAuMTMtMC42NDIgMC4zNjUtMC44NzZsMi4wODYtMi4wNzBjMC40MzItMC40MjkgMS4yNDUtMS4wNjAgMS44MzgtMC40NzIgMC4yNzIgMC4yNyAwLjcxMiAwLjI2OCAwLjk4MS0wLjAwM3MwLjI2OS0wLjcxMS0wLjAwMy0wLjk4MWMtMS4wMDctMS0yLjQ5Ny0wLjgxNS0zLjc5NCAwLjQ3MmwtMi4wODYgMi4wNzBjLTAuNSAwLjQ5Ny0wLjc3NiAxLjE1OC0wLjc3NiAxLjg2MXMwLjI3NiAxLjM2NCAwLjc3NiAxLjg2MWMwLjUxNSAwLjUxMiAxLjE5MSAwLjc2NiAxLjg2OCAwLjc2NnMxLjM1NC0wLjI1NSAxLjg2OS0wLjc2NmwwLjU2Ny0wLjU2NGMwLjI3Mi0wLjI3IDAuMjc0LTAuNzEgMC4wMDMtMC45ODFzLTAuNzEtMC4yNzMtMC45ODItMC4wMDN6TTExLjgyNCAyLjI0NmMtMS4wODItMS4wNzQtMi41OTUtMS4xMzItMy41OTctMC4xMzhsLTAuNzA2IDAuNzAxYy0wLjI3MiAwLjI3LTAuMjc0IDAuNzA5LTAuMDA0IDAuOTgxczAuNzEgMC4yNzQgMC45ODEgMC4wMDNsMC43MDYtMC43MDFjMC41MTktMC41MTUgMS4xOTgtMC4zMDIgMS42NDIgMC4xMzggMC4yMzYgMC4yMzQgMC4zNjUgMC41NDUgMC4zNjUgMC44NzZzLTAuMTMgMC42NDItMC4zNjUgMC44NzZsLTIuMjI2IDIuMjA4Yy0xLjAxNyAxLjAwOS0xLjQ5NSAwLjUzNi0xLjY5OSAwLjMzNC0wLjI3Mi0wLjI3LTAuNzExLTAuMjY4LTAuOTgxIDAuMDAzcy0wLjI2OSAwLjcxMiAwLjAwMyAwLjk4MWMwLjQ2NyAwLjQ2MyAxLjAwMSAwLjY5MyAxLjU2IDAuNjkzIDAuNjg1IDAgMS40MDgtMC4zNDQgMi4wOTUtMS4wMjdsMi4yMjUtMi4yMDhjMC41LTAuNDk2IDAuNzc2LTEuMTU3IDAuNzc2LTEuODZzLTAuMjc2LTEuMzY0LTAuNzc2LTEuODYxeiIgZmlsbD0iIzQ0NDQ0NCI+PC9wYXRoPgo8L3N2Zz4K);background-position:0 0;background-repeat:no-repeat;position:relative;top:-2px}@media (min-width:50em){.entry__title--external{margin-left:-20px}}.entry__description{color:#595959;line-height:1.3}.entry--project{padding:1em 1em .4em;background-color:#f8f8f8;-webkit-font-smoothing:antialiased}.u-desktop,.u-tablet{display:none}.u-mobile{display:block}@media (min-width:30em){.u-desktop,.u-mobile{display:none}.u-tablet{display:block}}@media (min-width:50em){.u-tablet,.u-mobile{display:none}.u-desktop{display:block}}.u-full-width{width:100%!important}.u-hidden,.is-hidden{display:none!important;visibility:hidden}.u-visuallyhidden,.is-visuallyhidden{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.u-visuallyhidden.focusable:active,.u-visuallyhidden.focusable:focus,.is-visuallyhidden.focusable:active,.is-visuallyhidden.focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}.no-js .js-only{display:none!important}.js .js-hidden,.is-contextual{display:none}</style><noscript><link rel="stylesheet" href="//static.davidrapson.co.uk/assets/4.0.1-pre/stylesheets/style.min.css"> </noscript><script>document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/g,"")+" js ",!function(){var e="undefined"!=typeof window?window:exports,n=[];if(e.performance||(e.performance={}),e.performance.now||(e.performance.now=performance.now||performance.webkitNow||performance.msNow||performance.mozNow),!e.performance.now){var r=Date.now?Date.now():+new Date;performance.timing&&performance.timing&&(r=performance.timing.navigationStart),e.performance.now=function(){var e=Date.now?Date.now():+new Date;return e-r}}e.performance.mark||(e.performance.mark=e.performance.webkitMark?e.performance.webkitMark:function(r){n.push({name:r,entryType:"mark",startTime:e.performance.now(),duration:0})}),e.performance.getEntriesByType||(e.performance.getEntriesByType=e.performance.webkitGetEntriesByType?e.performance.webkitGetEntriesByType:function(e){return"mark"==e?n:void 0})}(),window.markUserTime=function(e){var n=window.requestAnimationFrame||function(e){setTimeout(e,0)};n(function(){window.performance.mark(e),window.console&&console.timeStamp&&console.timeStamp(e)})}</script><script>!function(e){function t(){return"querySelector"in document&&"localStorage"in window&&"addEventListener"in window&&"withCredentials"in new XMLHttpRequest}function n(){var t,n,a=localStorage.getItem("css.a8c0f19137c97a9120b6bfd66348fb612548e4b9");a&&(t=document.createElement("style"),n=document.getElementsByTagName("head")[0],t.innerHTML=a,t.setAttribute("data-loaded-from","local"),n.appendChild(t),e.cssLoaded=!0)}function a(e){var t=document.getElementsByTagName("head")[0];t.appendChild(e)}function o(e){var t=document.createElement("style");t.innerHTML=e,t.setAttribute("data-loaded-from","ajax"),a(t)}function s(e){Object.keys(localStorage).forEach(function(e){e.match(/^css./g)&&localStorage.removeItem(e)});try{localStorage.setItem("css.a8c0f19137c97a9120b6bfd66348fb612548e4b9",e)}catch(t){}}function c(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,a(t)}function r(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.onreadystatechange=function(){4===t.readyState&&(200===t.status?(o(t.responseText),s(t.responseText)):c(d))},t.timeout=5e3,t.send()}var d="//static.davidrapson.co.uk/assets/4.0.1-pre/stylesheets/style.min.css";return n(),e.cssLoaded?!1:void(t()?r(d):c(d))}(this)</script><script src="//use.typekit.net/bem2aeh.js" onload="try{Typekit.load();}catch(e){}" async></script><script>window.markUserTime("aft.Head")</script></head><body itemscope itemtype="http://schema.org/WebPage"> <header class="global-header" role="banned"><div class="intro l-constrained"><div class="intro__media"> <a href="/" class="u-link-block"> <img class="u-full-width" src="//www.gravatar.com/avatar/ff58211f1f9ee8802ae7a66aa7a08dcd.png?s=120" alt="Avatar"> </a></div><div class="intro__body"><h1 class="intro__title"><a href="/">David Rapson</a> is a Birmingham born client-side developer living and working in London.</h1></div></div> </header><main class="main l-constrained" itemprop="mainContentOfPage"> <script>window.markUserTime("aft.Article Start")</script><article class="article copy--full" itemscope itemtype="http://schema.org/Article"> <header class="article__header"><div class="article__meta text--meta"> <time datetime="2014-11-20 00:00+0000" itemprop="dateCreated"> Nov 20, 2014 </time></div><h1 class="article__title" itemprop="headline">Improving performance</h1> </header><div class="article__lead u-text-lead copy" itemprop="description"><p>I’ve recently redesigned this website with the goal of making the fastest site I could and I wanted to explore some of the things I’ve done.</p></div><div class="article__body copy--full" itemprop="tet"><h2 id="pre-requisites">Pre-requisites</h2><p>Some pre-requisites. I use <a href="http://jekyllrb.com/">Jekyll</a> for my site and serve all static assets from <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>.</p><p>It’s also worth noting that I’ve deliberately left out mentions of <a href="https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/metrics/speed-index">SpeedIndex</a> from this article. It was a key metric when I was working on these improvements but it’s something I want to explore in more detail at another time.</p><p>Rather than focussing on every performance improvement I’ve made, I wanted to focus on three specific changes that have taken this site from good-performance to great-performance.</p><h2 id="inlining-critical-css">1. Inlining critical <span class="caps">CSS</span></h2><p>A lot has been written about the benefits of <a href="https://developers.google.com/speed/pagespeed/service/PrioritizeCriticalCss">inlining critical <span class="caps">CSS</span></a>. I’ve experimented with tools like <a href="https://github.com/addyosmani/critical">critical</a> before but never quite got the results I was looking for.</p><p>The biggest switch for me was to think of this as <strong>critical</strong> <span class="caps">CSS</span> rather than the “above-the-fold” approach that most tools focus on. This change in approach as allowed me to find an approach I’m really happy with.</p><p>I’m using <span class="caps">LESS</span> as a pre-processor and already split components out into individual includes so I was able to generate the critical <span class="caps">CSS</span> manually. For me this looked something like the following:</p><pre><code class="language-css"><span class="k">@import</span> <span class="s2">"base/_normalize.less"</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">"base/_base.less"</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">"layout/_layout.less"</span><span class="p">;</span>

<span class="k">@import</span> <span class="s2">"module/modules/_common-text"</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">"module/modules/_intro"</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">"module/modules/_navigation"</span><span class="p">;</span>

<span class="k">@import</span> <span class="s2">"state/_state-utility"</span><span class="p">;</span></code></pre><p><em>Critical</em> for this site meant layout styles, base typography styles and navigation. Essentially anything that causes major changes to layout or gives a good baseline experience. By setting a budget of about <strong>10 kb</strong> for this file I was able to keep it small enough to inline in the <code>&lt;head&gt;</code> of the page.</p><p>Before inlining critical <span class="caps">CSS</span> my mobile PageSpeed score was <strong>78/100</strong>:</p><figure> <img src="//static.davidrapson.co.uk/images/improving-performance/pagespeed-before-480by264-7d2815.jpg" sizes="100vw" data-srcset="//static.davidrapson.co.uk/images/improving-performance/pagespeed-before-800by441-7d2815.jpg 800w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-before-600by331-7d2815.jpg 600w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-before-480by264-7d2815.jpg 480w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-before-320by176-7d2815.jpg 320w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-before-480by264-7d2815.jpg 480w" class="js-lazyload lazyload" alt="Before inlining critical CSS"/> <figcaption>Before inlining critical <span class="caps">CSS</span></figcaption> </figure><p>After inlining critical <span class="caps">CSS</span> the PageSpeed score is now <strong>98/100</strong>.</p><figure> <img src="//static.davidrapson.co.uk/images/improving-performance/pagespeed-after-480by264-473f29.jpg" sizes="100vw" data-srcset="//static.davidrapson.co.uk/images/improving-performance/pagespeed-after-800by440-473f29.jpg 800w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-after-600by330-473f29.jpg 600w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-after-480by264-473f29.jpg 480w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-after-320by176-473f29.jpg 320w, //static.davidrapson.co.uk/images/improving-performance/pagespeed-after-480by264-473f29.jpg 480w" class="js-lazyload lazyload" alt="After inlining critical CSS"/> <figcaption>After inlining critical <span class="caps">CSS</span></figcaption> </figure><p>Combining this with storing <span class="caps">CSS</span> in localStorage (see next point) has given me the best results. The initial flash of styles that can happen when async loading the rest of the <span class="caps">CSS</span> now only happens on first page load.</p><h2 id="store-css-in-localstorage">2. Store <span class="caps">CSS</span> in localStorage</h2><p>In addition to inlining critical <span class="caps">CSS</span> I’ve also stolen a fantastic technique from Patrick Hamann in his <a href="https://speakerdeck.com/patrickhamann/breaking-news-at-1000ms-velocity-eu-2014">Breaking news at 1000ms</a> talk. The basic idea is that initially you load the main stylesheet via ajax and serve it from localStorage from then on.</p><p>I highly recommend <a href="https://github.com/guardian/frontend/blob/72f21c8bad4b1093a4699a532bddb1d127e971c8/common/app/views/fragments/javaScriptLaterSteps.scala.html#L104-L118">poking</a> <a href="https://github.com/guardian/frontend/blob/236af31e0588457f1721f3cf0ffda58ad409c74a/common/app/views/fragments/loadCss.scala.html#L11-L75">around</a> the Guardian’s <a href="https://github.com/guardian/frontend">public source</a> to see how they’ve approached it but you can also see the <a href="https://github.com/davidrapson/davidrapson.co.uk/blob/master/_includes/head.html#L31-L105">full source for my attempt on GitHub</a></p><h3 id="cachebusting">Cachebusting</h3><p>It took me a while of reading the <a href="https://github.com/guardian/frontend/blob/236af31e0588457f1721f3cf0ffda58ad409c74a/common/app/views/fragments/loadCss.scala.html#L31-L40">original code</a> but the trick to ensuring that user doesn’t get stuck with out-of-date <span class="caps">CSS</span> in localStorage is to use a hash of the stylesheet contents as the localStorage key. The main check that makes this work is:</p><pre><code class="language-javascript"><span class="kd">function</span> <span class="nx">loadCssFromStorage</span><span class="p">()</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'css.6adf242d29936ef2d6ba93c22547512f765d97e9'</span><span class="p">),</span>
  <span class="nx">s</span><span class="p">,</span> <span class="nx">head</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'style'</span><span class="p">);</span>
  <span class="nx">head</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">'head'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">'data-loaded-from'</span><span class="p">,</span> <span class="s1">'local'</span><span class="p">);</span>
  <span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
  <span class="nx">global</span><span class="p">.</span><span class="nx">cssLoaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="nx">loadCssFromStorage</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">cssLoaded</span><span class="p">)</span> <span class="p">{</span>
<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span></code></pre><p>As this script is inlined in the <code>&lt;head&gt;</code> we can make sure the hash referenced in <code>localStorage.getItem</code> is for the current stylesheet; meaning the <span class="caps">CSS</span> will only get loaded if the user has the <em>latest</em> version in storage already. Otherwise the new <span class="caps">CSS</span> should be requested and stored and any old versions cleared.</p><h3 id="getting-the-hash-into-jekyll">Getting the hash into Jekyll</h3><p>As I’m using Jekyll I needed a way to reference the latest hash in the <code>&lt;head&gt;</code> of the page. Thankfully Jekyll allows the creating of <a href="http://jekyllrb.com/docs/datafiles/">custom data files</a> as a means of allowing data to be referenced in templates.</p><p>To get the correct hash I used Gulp to get an <span class="caps">MD5</span> hash of the contents of my stylesheets and generate a <span class="caps">JSON</span> file in the <code>_data</code> directory with the following format:</p><pre><code class="language-json"><span class="p">{</span>
    <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"3.1.0"</span><span class="p">,</span>
    <span class="nt">"head"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"hash"</span><span class="p">:</span> <span class="s2">"ae127b3e71571938ce0e7a6a39e63d738afd0577"</span>
    <span class="p">},</span>
    <span class="nt">"style"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"hash"</span><span class="p">:</span> <span class="s2">"6adf242d29936ef2d6ba93c22547512f765d97e9"</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre><p>This then allowed me to reference the correct hash in my templates as <code>site.data.assets.style.hash</code>. I also use this file to determining the correct version of the stylesheet to get from CloudFront.</p><h3 id="a-note-on-cors-and-cloudfront">A note on <abbr title="Cross-origin resource sharing"><span class="caps">CORS</span></abbr> and CloudFront</h3><p>This method depends on using <span class="caps">XHR</span> to initially load the stylesheet. As my <span class="caps">CSS</span> is served from CloudFront and stored on <span class="caps">S3</span> I added a <abbr title="Cross-origin resource sharing"><span class="caps">CORS</span></abbr> config to my <span class="caps">S3</span> bucket. The thing that caught me out was that by default CloudFront doesn’t forward any headers so the <code>Access-Control-Allow-Origin</code> header was ignored. Thankfully the solution is to set CloudFront to forward the <code>Origin</code> header:</p><blockquote><p><abbr title="Cross-origin resource sharing"><span class="caps">CORS</span></abbr> (Cross Origin Resource Sharing) - CloudFront can now be used to deliver web assets such as JavaScript and fonts to other websites. Because CloudFront can now be configured to pass the Origin header along to the origin server, you can now use <abbr title="Cross-origin resource sharing"><span class="caps">CORS</span></abbr> to allow cross-origin access to your content.</p><p>– <a href="http://aws.amazon.com/blogs/aws/enhanced-cloudfront-customization/">Deliver Custom Content With CloudFront</a></p></blockquote><h2 id="minify-html">3. Minify <span class="caps">HTML</span></h2><p>The final step I took was to minify <span class="caps">HTML</span> output. The <a href="https://github.com/imathis/jekyll-minify-html">Jekyll Minify <span class="caps">HTML</span></a> plugin let me do this with about three lines of config. I wouldn’t go out of my way to do this but if your setup makes this easy for you without incurring any major overhead then you should do it.</p><h2 id="final-hold-out">Final hold-out</h2><p>The elephant in the room when it comes to remaining performance bottlenecks is that I’m serving web-fonts from Typekit. I’m using the <a href="http://help.typekit.com/customer/portal/articles/649336-embed-code">async embed code</a> but ultimately using external web-fonts is a hit to performance.</p><p>I’m using web-fonts from <a href="http://www.type-together.com/">TypeTogether</a> so I could potentially look at self-hosting but currently the cost of doing so is prohibitive, so the trade off is worth it.</p><h2 id="wrap-up">Wrap-up</h2><p>If you’ve already got the basics down – minify, gzip, cache – it’s worth spending the time exploring further optimisations. These techniques can take some fine-tuning, and as always <abbr title="Your mileage may vary"><span class="caps">YMMV</span></abbr>, but if you can get something that works for you it can drastically improve the performance of your page.</p></div> </article> </main><footer class="global-footer l-constrained" role="contentinfo"><ul class="nav-trail"><li class="nav-trail__item"><a href="http://github.com/davidrapson/">GitHub</a></li><li class="nav-trail__item"><a href="http://twitter.com/davidrapson/">Twitter</a></li><li class="nav-trail__item"><a href="/colophon.html">Colophon</a></li></ul> </footer><script>window.lazySizesConfig={lazyClass:"js-lazyload",addClasses:!0,loadingClass:"is-loading",loadedClass:"is-loaded",clearAttr:!0}</script><script src="//static.davidrapson.co.uk/assets/4.0.1-pre/javascripts/combined.min.js" async defer></script><script>!function(e,t,a,n,c,o){e.GoogleAnalyticsObject=n,e[n]||(e[n]=function(){(e[n].q=e[n].q||[]).push(arguments)}),e[n].l=+new Date,c=t.createElement(a),o=t.getElementsByTagName(a)[0],c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script","ga"),ga("create","UA-56926844-1","auto"),ga("send","pageview")</script></body></html>